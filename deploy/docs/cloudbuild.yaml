steps:

# Download the latest version of the docs-controller image
- name: gcr.io/cloud-builders/docker
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    docker pull gcr.io/$PROJECT_ID/docs-controller:v2 || exit 0
  # until https://github.com/GoogleCloudPlatform/cloud-builders/issues/253 is fixed

# Build and push latest version of the docs-controller image
- name: gcr.io/cloud-builders/docker
  args:
  - 'build'
  - '-t'
  - 'gcr.io/$PROJECT_ID/docs-controller:v2'
  - '--cache-from'
  - 'gcr.io/$PROJECT_ID/docs-controller:v2'
  - '--target'
  - 'hugo-publish'
  - 'docs'

- name: gcr.io/$PROJECT_ID/docs-controller:v2
  env: ['BASE_URL=https://skaffold-latest.firebaseapp.com', 'PROJECT_ID=$PROJECT_ID']

images:
- 'gcr.io/$PROJECT_ID/docs-controller:v2'
